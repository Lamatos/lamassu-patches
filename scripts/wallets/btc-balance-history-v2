#!/usr/bin/env bash
set -e

# Ensure jq is installed
if ! command -v jq >/dev/null 2>&1; then
  echo "jq not found, installing..."
  DEBIAN_FRONTEND=noninteractive apt-get install -y jq >/dev/null
fi

# Output file
OUTFILE="/tmp/btc-funding-history.csv"

# Write CSV header
echo "address,amount,txid,time" > "$OUTFILE"

# Query transactions and filter to only external deposits
bitcoin-cli -conf=/mnt/blockchains/bitcoin/bitcoin.conf listtransactions "*" 1000 |
jq -r '
  map(select(.category == "receive"))
  | map(select(.txid as $txid | any(.category == "send" and .txid == $txid) | not))
  | .[] | [.address, .amount, .txid, (.time | strftime("%Y-%m-%d %H:%M:%S"))] | @csv
' >> "$OUTFILE"

echo "Funding history exported to $OUTFILE"