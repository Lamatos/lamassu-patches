#!/usr/bin/env bash
set -euo pipefail

CONF="/mnt/blockchains/bitcoin/bitcoin.conf"
OUT="/tmp/btc-funding-history.csv"

# Ensure jq exists
if ! command -v jq >/dev/null 2>&1; then
  echo "jq not found, installing..."
  DEBIAN_FRONTEND=noninteractive apt-get update -y >/dev/null
  DEBIAN_FRONTEND=noninteractive apt-get install -y jq >/dev/null
fi

echo "address,amount,txid,time" > "$OUT"

COUNT=1000
SKIP=0

while :; do
  JSON="$(bitcoin-cli -conf="$CONF" listtransactions "*" $COUNT $SKIP true)"
  # stop if no more results
  [[ "$JSON" == "[]" || -z "$JSON" ]] && break

  echo "$JSON" | jq -r '
    . as $all
    | [ .[] 
        | select(.category == "receive")
        | .txid as $tx
        | select( any($all[]; .category == "send" and .txid == $tx) | not )
      ]
    | sort_by(.time)
    | .[]
    | [ .address, .amount, .txid, (.time | strftime("%Y-%m-%d %H:%M:%S")) ]
    | @csv
  ' >> "$OUT"

  # if fewer than COUNT returned, we're done
  [[ $(echo "$JSON" | jq 'length') -lt $COUNT ]] && break
  SKIP=$((SKIP + COUNT))
done

echo "Funding history exported to $OUT"